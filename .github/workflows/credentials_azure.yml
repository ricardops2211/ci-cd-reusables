name: credentials_azure

on:
  workflow_call:
    inputs:
      vault_addr:
        description: "Dirección de Vault"
        required: false
        type: string
        default: "http://127.0.0.1:8200"
      secret_path:
        description: "Ruta del secreto en Vault"
        required: false
        type: string
        default: "secret/azure"
      field:
        description: "Campo con el Databricks PAT"
        required: false
        type: string
        default: "DATABRICKS_TOKEN"
    secrets:
      VAULT_TOKEN:
        required: true
    outputs:
      DATABRICKS_TOKEN:
        description: "Databricks PAT obtenido de Vault"
        value: ${{ jobs.get-token.outputs.databricks_token }}

jobs:
  get-token:
    runs-on: self-hosted
    outputs:
      databricks_token: ${{ steps.get-creds.outputs.token }}
    steps:
      - name: Login en Vault
        shell: bash
        env:
          VAULT_ADDR: ${{ inputs.vault_addr }}
          VAULT_TOKEN: ${{ secrets.VAULT_TOKEN }}
          VAULT_SKIP_VERIFY: "true"
          PATH: ${{ env.PATH }}:/home/gha-runner/vault
        run: |
          set -Eeuo pipefail
          vault --version
          vault login "$VAULT_TOKEN" >/dev/null
          vault token lookup

      - name: Obtener token de Databricks
        id: get-creds
        shell: bash
        env:
          VAULT_ADDR: ${{ inputs.vault_addr }}
          VAULT_SKIP_VERIFY: "true"
          PATH: ${{ env.PATH }}:/home/gha-runner/vault
        run: |
          set -Eeuo pipefail
          dbToken=$(vault kv get -field="${{ inputs.field }}" "${{ inputs.secret_path }}")
          echo "::add-mask::$dbToken"
          # ✔️ exporta a entorno para las siguientes steps (si hiciera falta localmente)
          echo "DATABRICKS_TOKEN=$dbToken" >> "$GITHUB_ENV"
          # y lo exponemos como output del workflow reusable
          echo "token=$dbToken" >> "$GITHUB_OUTPUT"
